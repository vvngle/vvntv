-- =============================================
-- MoonTV D1 数据库初始化脚本（完整版）
-- 执行本脚本 + 设置环境变量 = 所有操作永久保存 + 站长全功能可用
-- 关键环境变量（必须设置）：
--   NEXT_PUBLIC_STORAGE_TYPE=d1
--   （Vercel/Cloudflare Pages 中必须添加此变量，否则仍走 localStorage！）
-- =============================================

CREATE TABLE IF NOT EXISTS users (
    username TEXT PRIMARY KEY,
    password TEXT NOT NULL,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE IF NOT EXISTS play_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    key TEXT NOT NULL,
    title TEXT NOT NULL,
    source_name TEXT NOT NULL,
    cover TEXT NOT NULL,
    year TEXT NOT NULL,
    index_episode INTEGER NOT NULL,
    total_episodes INTEGER NOT NULL,
    play_time INTEGER NOT NULL,
    total_time INTEGER NOT NULL,
    save_time INTEGER NOT NULL,
    search_title TEXT,
    UNIQUE(username, key)
);

CREATE TABLE IF NOT EXISTS favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    key TEXT NOT NULL,
    title TEXT NOT NULL,
    source_name TEXT NOT NULL,
    cover TEXT NOT NULL,
    year TEXT NOT NULL,
    total_episodes INTEGER NOT NULL,
    save_time INTEGER NOT NULL,
    UNIQUE(username, key)
);

CREATE TABLE IF NOT EXISTS search_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    keyword TEXT NOT NULL,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    UNIQUE(username, keyword)
);

CREATE TABLE IF NOT EXISTS admin_config (
    id INTEGER PRIMARY KEY DEFAULT 1,
    config TEXT NOT NULL,
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 智能跳过片头片尾配置表（用户级别可单独设置）
CREATE TABLE IF NOT EXISTS skip_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    source TEXT NOT NULL,
    id_video TEXT NOT NULL,
    enable INTEGER NOT NULL DEFAULT 1,        -- 默认开启跳过
    intro_time INTEGER NOT NULL DEFAULT 90,   -- 默认跳过前 90 秒（可按影片自动调整）
    outro_time INTEGER NOT NULL DEFAULT 90,   -- 默认跳过后 90 秒（可按影片自动调整）
    UNIQUE(username, source, id_video)
);

-- =============================================
-- 重要：执行完以上 SQL 后，请务必在部署平台（Vercel / Cloudflare Pages）添加以下环境变量：
-- 
-- KEY:   NEXT_PUBLIC_STORAGE_TYPE
-- VALUE: d1
-- 
-- 加上这行后：
--   ┌ 收藏、播放记录、搜索历史、跳过片头片尾设置全部永久保存
--   ┌ 多设备同步生效
--   ┌ /admin 站长面板全功能解锁
--   └ 不加这行 = 仍然使用 localStorage，所有数据刷新即丢失！
-- =============================================
