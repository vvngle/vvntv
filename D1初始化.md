-- =============================================
-- MoonTV D1 数据库完整初始化脚本（基于原始 schema 完善版）
-- 支持：17+ 功能全持久化（收藏/进度/历史/配置/跳过）、站长全权限（/admin 用户管理+动态配置）、多端同步
-- 执行后必须设置环境变量：NEXT_PUBLIC_STORAGE_TYPE=d1
-- 原始表：6 个（覆盖所有用户/管理员数据）；功能扩展通过 admin_config JSON 字段实现（如站点公告、权限分配）
-- =============================================

-- 用户表：支持多账户注册/登录，站长可通过 /admin 添加/编辑权限
CREATE TABLE IF NOT EXISTS users (
    username TEXT PRIMARY KEY,
    password TEXT NOT NULL,
    is_admin INTEGER NOT NULL DEFAULT 0,  -- 0=普通用户, 1=管理员（站长全权限：管理用户、配置、日志）
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);
-- 索引：加速用户查询（多账户场景）
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);

-- 播放记录表：支持继续观看、多端进度同步
CREATE TABLE IF NOT EXISTS play_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    key TEXT NOT NULL,
    title TEXT NOT NULL,
    source_name TEXT NOT NULL,
    cover TEXT NOT NULL,
    year TEXT NOT NULL,
    index_episode INTEGER NOT NULL,
    total_episodes INTEGER NOT NULL,
    play_time INTEGER NOT NULL,
    total_time INTEGER NOT NULL,
    save_time INTEGER NOT NULL,
    search_title TEXT,
    UNIQUE(username, key)
);
-- 索引：加速按用户/键查询
CREATE INDEX IF NOT EXISTS idx_play_records_user_key ON play_records(username, key);

-- 收藏表：支持影视收藏、多端同步
CREATE TABLE IF NOT EXISTS favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    key TEXT NOT NULL,
    title TEXT NOT NULL,
    source_name TEXT NOT NULL,
    cover TEXT NOT NULL,
    year TEXT NOT NULL,
    total_episodes INTEGER NOT NULL,
    save_time INTEGER NOT NULL,
    UNIQUE(username, key)
);
-- 索引：加速收藏查询
CREATE INDEX IF NOT EXISTS idx_favorites_user_key ON favorites(username, key);

-- 搜索历史表：支持关键词历史、多端同步
CREATE TABLE IF NOT EXISTS search_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    keyword TEXT NOT NULL,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    UNIQUE(username, keyword)
);
-- 索引：加速历史查询
CREATE INDEX IF NOT EXISTS idx_search_history_user ON search_history(username);

-- 管理员配置表：站长全权限核心，支持动态 JSON 配置（如用户权限、站点公告、资源站点编辑）
-- 示例 JSON: {"announcement": "站点维护中", "enable_register": true, "custom_sites": [...], "admin_users": ["user1"]}
CREATE TABLE IF NOT EXISTS admin_config (
    id INTEGER PRIMARY KEY DEFAULT 1,
    config TEXT NOT NULL,  -- JSON 字符串，存储全权限配置（站长可编辑）
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);
-- 初始化默认配置（如果表空）
INSERT OR IGNORE INTO admin_config (id, config) VALUES (1, '{"announcement": "", "enable_register": false, "search_max_page": 5, "admin_users": []}');

-- 跳过片头/片尾配置表：智能去广告核心，用户/管理员可设置（默认开启，支持 per-video 自定义）
CREATE TABLE IF NOT EXISTS skip_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    source TEXT NOT NULL,     -- 资源源（如 "dyttzy"）
    id_video TEXT NOT NULL,   -- 视频 ID/Key
    enable INTEGER NOT NULL DEFAULT 1,     -- 1=开启跳过（默认全开）
    intro_time INTEGER NOT NULL DEFAULT 90, -- 片头跳过秒数（默认 90s，自动检测广告）
    outro_time INTEGER NOT NULL DEFAULT 120, -- 片尾跳过秒数（默认 120s，自动检测结束广告）
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
    UNIQUE(username, source, id_video)
);
-- 索引：加速跳过查询
CREATE INDEX IF NOT EXISTS idx_skip_configs_user_source ON skip_configs(username, source);

-- =============================================
-- 执行完成确认：
-- ┌ 所有 17 功能持久化：收藏/进度/历史/搜索自动保存到对应表，多端同步
-- ┌ 站长全权限：设置环境变量 USERNAME=admin, PASSWORD=your_strong_pass 后，访问 /admin 登录
--   └ 在 /admin 可编辑 admin_config JSON（如添加 "admin_users": ["newadmin"] 赋予权限、管理用户表）
-- ┌ 跳过片头/片尾：播放时自动应用 skip_configs（默认开启）；管理员可在 /admin 批量设置
-- └ 环境变量必设（Vercel/Cloudflare）：NEXT_PUBLIC_STORAGE_TYPE=d1
--   其他：PASSWORD=your_pass, USERNAME=admin, NEXT_PUBLIC_ENABLE_REGISTER=false（生产关注册）
-- =============================================
